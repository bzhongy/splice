module TestPayloadBuilder where

import Daml.Script
import DA.Assert ((===))
import DA.List (head, last, (!!))
import DA.Text qualified as T
import PayloadBuilder


-- Test: Create payload from multiple indices
testCreatePayloadFromIndices : Script ()
testCreatePayloadFromIndices = script do
  let components = createPayloadFromIndices [1, 3, 5, 7, 9]
  
  length components.rs === 5
  length components.ss === 5
  
  head components.rs === "1c562526fce837b57e251024ea59cdbe12dada08442da1f2db96ca7f9750faae"
  head components.ss === "2abcbc6adf6ca466e33475f9488bf0e4dadcdad4c86e5d2b85d94a237427c463"

-- Test: Create payload with duplicate indices
testCreatePayloadWithDuplicates : Script ()
testCreatePayloadWithDuplicates = script do
  let components = createPayloadFromIndices [1, 3, 5, 7, 7]
  
  length components.rs === 5
  length components.ss === 5
  
  (components.rs !! 3) === (components.rs !! 4)
  (components.ss !! 3) === (components.ss !! 4)

-- Test: Create payload from single index
testCreatePayloadSingleIndex : Script ()
testCreatePayloadSingleIndex = script do
  let components = createPayloadFromIndices [0]
  
  length components.rs === 1
  length components.ss === 1
  
  head components.rs === "5d0435f40e7172cd397e86966f83c820b92003302fd442cc61bd4e9497f7ec33"
  head components.ss === "1290f9db1a405a4d6b21a617a918075eff0858f0339e0a3242eb7f31377f0c11"

-- Test: Create payload from all 31 indices
testCreatePayloadAllIndices : Script ()
testCreatePayloadAllIndices = script do
  let components = createPayloadFromIndices [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30]
  
  length components.rs === 31
  length components.ss === 31
  
  head components.rs === "5d0435f40e7172cd397e86966f83c820b92003302fd442cc61bd4e9497f7ec33"
  last components.rs === "98d3b2fbdbdbaf0aa2acb151380d5593bcabc62a0e0c38b3f39aceb0d3f9f465"

-- Test: Create payload from non-sequential indices
testCreatePayloadNonSequential : Script ()
testCreatePayloadNonSequential = script do
  let components = createPayloadFromIndices [15, 0, 8, 3]
  
  length components.rs === 4
  length components.ss === 4
  
  (components.rs !! 0) === "5209fae2c1fb019b832ebf86238033d1a1ccf62863b61bbff25075eb8b83ed92"
  (components.rs !! 1) === "5d0435f40e7172cd397e86966f83c820b92003302fd442cc61bd4e9497f7ec33"
  (components.rs !! 2) === "e5dc7c296755b356b03b199d8e7738bf44b59ee8e680b81caa4af5f7149e688a"
  (components.rs !! 3) === "e1d3a30a1fa209e027393ff2e7cf6d1e3d0a20eadb7f19e400e9b7e9d9848ede"



-- Test: V value packing from different signer combinations
testVValuePacking : Script ()
testVValuePacking = script do
  -- V values: [1, 1, 1, 1, 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1]
  let components3 = createPayloadFromIndices [0, 1, 2]
  components3.rawVs === "0101010000000000000000000000000000000000000000000000000000000000"
  
  let components1 = createPayloadFromIndices [0]
  components1.rawVs === "0100000000000000000000000000000000000000000000000000000000000000"
  
  let components2 = createPayloadFromIndices [3, 4]
  components2.rawVs === "0100000000000000000000000000000000000000000000000000000000000000"
  
  let components4 = createPayloadFromIndices [0, 2, 5]
  components4.rawVs === "0101010000000000000000000000000000000000000000000000000000000000"
  
  let components5 = createPayloadFromIndices [0, 3, 5]
  components5.rawVs === "0101010000000000000000000000000000000000000000000000000000000000"

-- Test: Payload structure validation - verify all components present
testPayloadStructureValidation : Script ()
testPayloadStructureValidation = script do
  let components = createPayloadFromIndices [0, 5, 10]
  
  -- Verify all required components are present and non-empty
  length components.context === 3
  assert (components.report /= "")
  length components.rs === 3
  length components.ss === 3
  assert (components.rawVs /= "")
  
  -- Verify context values match expected fixture data
  head components.context === "0006f9b24eb618e92e9fa3c97a6c1d60a4055d8a0c9649b3717c8a3583617121"

-- Test: Encoded payload has correct static size prefix
testEncodedPayloadStaticSize : Script ()
testEncodedPayloadStaticSize = script do
  let components = createPayloadFromIndices [0, 1]
  let encoded = encodePayload components
  
  -- First 7 words (224 bytes = 448 hex chars) are static data:
  -- - 3 words for context (96 bytes)
  -- - 1 word for reportDataOffset (32 bytes)
  -- - 1 word for rsOffset (32 bytes)
  -- - 1 word for ssOffset (32 bytes)
  -- - 1 word for rawVs (32 bytes)
  -- Total static = 224 bytes = 448 hex characters
  
  -- Verify the payload is longer than static size
  assert (T.length encoded > 448)
