module Interface.TestConfirmedOwner where

import Interface.ConfirmedOwner
import Daml.Script
import DA.Assert
import DA.Optional

-- Test contract implementing ConfirmedOwner interface
template TestConfirmedOwnerContract
  with
    owner : Party
    pendingOwner : Optional Party
    observers : [Party]
  where
    signatory owner
    observer observers

    interface instance ConfirmedOwner for TestConfirmedOwnerContract where
      view = ConfirmedOwnerView with owner = owner, pendingOwner = pendingOwner
      updateConfirmedOwner newView = do
        contractId <- create this with owner = newView.owner, pendingOwner = newView.pendingOwner
        return (toInterfaceContractId @ConfirmedOwner contractId)

    choice AddObserver : ContractId TestConfirmedOwnerContract
      with newObserver : Party
      controller owner
      do
        create this with observers = newObserver :: observers

-- Test: Owner can transfer ownership to another party
testTransferOwnershipAsOwner : Script ()
testTransferOwnershipAsOwner = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  
  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = []
  
  -- Alice initiates transfer to Bob
  newCid <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) TransferOwnership
      with newOwner = bob
  
  pendingOwner <- alice `submit` do
    exerciseCmd newCid GetPendingOwner with viewer = alice
  
  pendingOwner === Some bob

-- Test: Non-owner cannot transfer ownership (authorization check)
testTransferOwnershipAsNonOwner : Script ()
testTransferOwnershipAsNonOwner = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  charlie <- allocateParty "Charlie"
  
  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = [bob]
  
  -- Bob attempts transfer despite not being owner (not a signatory)
  submitMustFail bob do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) TransferOwnership
      with newOwner = charlie

-- Test: Cannot transfer ownership to existing owner
testTransferOwnershipToExistingOwner : Script ()
testTransferOwnershipToExistingOwner = script do
  alice <- allocateParty "Alice"
  
  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = []
  
  -- Self-transfer should fail
  submitMustFail alice do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) TransferOwnership
      with newOwner = alice

-- Test: Transfer ownership updates pending owner field
testTransferOwnershipUpdatesPendingOwner : Script ()
testTransferOwnershipUpdatesPendingOwner = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  charlie <- allocateParty "Charlie"
  
  -- Bob starts as pending owner
  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = Some bob
      observers = []
  
  -- Alice transfers to Charlie, pending owner should change from Bob to Charlie
  newCid <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) TransferOwnership
      with newOwner = charlie
  
  pendingOwner <- alice `submit` do
    exerciseCmd newCid GetPendingOwner with viewer = alice
  
  pendingOwner === Some charlie

-- Test: Pending owner can accept ownership
testAcceptOwnershipAsPendingOwner : Script ()
testAcceptOwnershipAsPendingOwner = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"

  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = []

  -- Alice transfers to Bob
  transferCid <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) TransferOwnership
      with newOwner = bob

  -- Alice adds Bob as observer so he can accept ownership
  let templateCid = fromInterfaceContractId @TestConfirmedOwnerContract transferCid
  observableCid <- alice `submit` do
    exerciseCmd templateCid AddObserver with newObserver = bob

  -- Bob accepts, becoming the new owner
  acceptCid <- bob `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner observableCid) AcceptOwnership

  owner <- bob `submit` do
    exerciseCmd acceptCid GetOwner with viewer = bob

  pendingOwner <- bob `submit` do
    exerciseCmd acceptCid GetPendingOwner with viewer = bob

  owner === bob
  assert (isNone pendingOwner)

-- Test: Non-pending owner cannot accept ownership
testAcceptOwnershipAsNonPendingOwner : Script ()
testAcceptOwnershipAsNonPendingOwner = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  charlie <- allocateParty "Charlie"
  
  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = []
  
  -- Alice transfers to Bob
  transferCid <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) TransferOwnership
      with newOwner = bob
  
  -- Charlie attempts to accept despite not being pending owner
  submitMustFail charlie do
    exerciseCmd transferCid AcceptOwnership

-- Test: GetOwner returns current owner
testGetOwner : Script ()
testGetOwner = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  
  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = Some bob
      observers = []
  
  owner <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) GetOwner with viewer = alice
  
  owner === alice

-- Test: GetPendingOwner returns pending owner
testGetPendingOwner : Script ()
testGetPendingOwner = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  
  -- Test with no pending owner
  cid1 <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = []

  pendingOwner1 <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid1) GetPendingOwner with viewer = alice

  assert (isNone pendingOwner1)

  -- Test with pending owner
  cid2 <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = Some bob
      observers = []
  
  pendingOwner2 <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid2) GetPendingOwner with viewer = alice
  
  pendingOwner2 === Some bob

-- Test: Complete ownership workflow including transfer and acceptance
testCompleteOwnershipWorkflow : Script ()
testCompleteOwnershipWorkflow = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"

  cid1 <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = []

  -- Alice transfers ownership to Bob
  cid2 <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid1) TransferOwnership
      with newOwner = bob

  -- Verify Bob is pending owner
  pendingOwner <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid2) GetPendingOwner with viewer = alice

  pendingOwner === Some bob

  -- Alice adds Bob as observer so he can accept ownership
  let templateCid2 = fromInterfaceContractId @TestConfirmedOwnerContract cid2
  observableCid <- alice `submit` do
    exerciseCmd templateCid2 AddObserver with newObserver = bob

  -- Bob accepts ownership
  cid3 <- bob `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner observableCid) AcceptOwnership

  -- Verify final state: Bob is owner, no pending owner
  finalOwner <- bob `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid3) GetOwner with viewer = bob

  finalPendingOwner <- bob `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid3) GetPendingOwner with viewer = bob

  finalOwner === bob
  assert (isNone finalPendingOwner)

-- Test: Accept ownership with no pending owner should fail
testAcceptOwnershipWithNoPendingOwner : Script ()
testAcceptOwnershipWithNoPendingOwner = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"

  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = [bob]

  -- Bob attempts to accept ownership when there is no pending owner
  -- This should fail because pendingOwner is None
  submitMustFail bob do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) AcceptOwnership

-- Test: Stale pending owner cannot accept after being superseded
testStalePendingOwnerCannotAccept : Script ()
testStalePendingOwnerCannotAccept = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  charlie <- allocateParty "Charlie"

  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = None
      observers = []

  -- Alice transfers to Bob
  transferCid1 <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) TransferOwnership
      with newOwner = bob

  -- Add Bob as observer so he can see the contract
  let templateCid1 = fromInterfaceContractId @TestConfirmedOwnerContract transferCid1
  observableCid1 <- alice `submit` do
    exerciseCmd templateCid1 AddObserver with newObserver = bob

  -- Alice supersedes the transfer by transferring to Charlie instead
  transferCid2 <- alice `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner observableCid1) TransferOwnership
      with newOwner = charlie

  -- Verify Charlie is now the pending owner
  pendingOwner <- alice `submit` do
    exerciseCmd transferCid2 GetPendingOwner with viewer = alice

  pendingOwner === Some charlie

  -- Bob (stale pending owner) attempts to accept - should fail
  submitMustFail bob do
    exerciseCmd transferCid2 AcceptOwnership

-- Test: Query authorization from different parties
testQueryAuthorizationFromDifferentParties : Script ()
testQueryAuthorizationFromDifferentParties = script do
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  charlie <- allocateParty "Charlie"

  cid <- alice `submit` do
    createCmd TestConfirmedOwnerContract with
      owner = alice
      pendingOwner = Some bob
      observers = [bob]

  -- Bob (observer) can query GetOwner
  ownerFromBob <- bob `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) GetOwner
      with viewer = bob

  ownerFromBob === alice

  -- Bob (observer) can query GetPendingOwner
  pendingFromBob <- bob `submit` do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) GetPendingOwner
      with viewer = bob

  pendingFromBob === Some bob

  -- Charlie (non-observer) cannot query GetOwner - should fail
  submitMustFail charlie do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) GetOwner
      with viewer = charlie

  -- Charlie (non-observer) cannot query GetPendingOwner - should fail
  submitMustFail charlie do
    exerciseCmd (toInterfaceContractId @ConfirmedOwner cid) GetPendingOwner
      with viewer = charlie
